#!/usr/bin/env node

const { execSync } = require('child_process');
const path = require('path');
const fs = require('fs');

function run() {
  const ROOT = path.resolve(__dirname, '..');
  process.chdir(ROOT);

  console.log("Updating translations...");

  const localePath = path.join(ROOT, 'packages/desktop-client/locale');
  if (!fs.existsSync(localePath)) {
    // Clone the translations repository if it doesn't exist
    execSync('git clone https://github.com/actualbudget/translations packages/desktop-client/locale', { stdio: 'inherit' });
  }

  // Navigate into the locale directory and update
  process.chdir(localePath);
  execSync('git checkout .', { stdio: 'inherit' });
  execSync('git pull', { stdio: 'inherit' });

  // Return to the root directory
  process.chdir(ROOT);

  // Call the remove untranslated languages script (if needed)
  execSync('node packages/desktop-client/bin/remove-untranslated-languages', { stdio: 'inherit' });

  // Set the NODE_OPTIONS environment variable
  process.env.NODE_OPTIONS = '--max-old-space-size=4096';

  // Run the build commands for each workspace
  execSync('yarn workspace plugins-service build', { stdio: 'inherit' });
  execSync('yarn workspace loot-core build:browser', { stdio: 'inherit' });
  execSync('yarn workspace @actual-app/web build:browser', { stdio: 'inherit' });

  console.log('packages/desktop-client/build');
}

run();
