#!/usr/bin/env node

// Exit on unhandled errors
process.on("unhandledRejection", err => { throw err; });

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

// ------------------------------------------------------------
// Helper to run shell commands
function run(cmd, opts = {}) {
  console.log(`> ${cmd}`);
  execSync(cmd, { stdio: "inherit", ...opts });
}

// ------------------------------------------------------------
// Ensure node_modules exists and is not empty
const nodeModulesPath = path.join(process.cwd(), "node_modules");
const nodeModulesMissing =
  !fs.existsSync(nodeModulesPath) ||
  fs.readdirSync(nodeModulesPath).length === 0;

if (nodeModulesMissing) {
  run("yarn");
}

// ------------------------------------------------------------
// Default environment variable
let E2E_START_URL = process.env.E2E_START_URL || "https://localhost:3001";
let VRT_ARGS = "";

// Argument parsing (mirrors the shell script)
const argv = process.argv.slice(2);
for (let i = 0; i < argv.length; i++) {
  const key = argv[i];

  switch (key) {
    case "--e2e-start-url":
      E2E_START_URL = argv[i + 1];
      i++;
      break;

    default:
      VRT_ARGS += " " + key;
      break;
  }
}

// ------------------------------------------------------------
// Output parameters
console.log("Running VRT tests with the following parameters:");
console.log("E2E_START_URL:", E2E_START_URL);
console.log("VRT_ARGS:", VRT_ARGS.trim());

// ------------------------------------------------------------
// Docker run command
//
// In Bash you used:
//
//   MSYS_NO_PATHCONV=1 docker run ... -c "E2E_START_URL=$E2E_START_URL yarn vrt $VRT_ARGS"
//
// We replicate that exactly.
//

const dockerCmd =
  `MSYS_NO_PATHCONV=1 docker run --rm --network host ` +
  `-v "${process.cwd()}":/work/ -w /work/ -it ` +
  `mcr.microsoft.com/playwright:v1.56.0-jammy /bin/bash ` +
  `-c "E2E_START_URL=${E2E_START_URL} yarn vrt ${VRT_ARGS}"`;

run(dockerCmd);
