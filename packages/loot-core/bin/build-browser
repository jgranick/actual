#!/usr/bin/env node

// Equivalent to: set -e
process.on("unhandledRejection", err => { throw err; });

const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

// ---------------------------------------------------------------------------
// Helpers
function run(cmd, opts = {}) {
  console.log(`> ${cmd}`);
  execSync(cmd, { stdio: "inherit", ...opts });
}

function rmrf(target) {
  if (!fs.existsSync(target)) return;
  const stat = fs.statSync(target);
  if (stat.isDirectory()) {
    fs.rmSync(target, { recursive: true, force: true });
  } else {
    fs.rmSync(target, { force: true });
  }
}

function mkdirp(dir) {
  fs.mkdirSync(dir, { recursive: true });
}

// ---------------------------------------------------------------------------
// Change into script directory (equivalent to `cd dirname "$0"`)
const SCRIPT_DIR = path.dirname(fs.realpathSync(__filename));
process.chdir(SCRIPT_DIR);
const ROOT = process.cwd();

let VITE_ARGS = "";

// ---------------------------------------------------------------------------
// Paths
const PUBLIC_DIR = path.join(ROOT, "../../desktop-client/public");
const DATA_DIR = path.join(PUBLIC_DIR, "data");

// ---------------------------------------------------------------------------
// Ensure data directory exists and copy migrations into it
mkdirp(DATA_DIR);

// Run the migration script
run(`node "${path.join(ROOT, "copy-migrations")}" "${DATA_DIR}"`);

// ---------------------------------------------------------------------------
// Generate sorted file list
const allFiles = fs
  .readdirSync(DATA_DIR, { withFileTypes: true })
  .filter(d => d.isFile())
  .map(d => d.name)
  .sort();

fs.writeFileSync(
  path.join(PUBLIC_DIR, "data-file-index.txt"),
  allFiles.join("\n") + "\n"
);

// ---------------------------------------------------------------------------
// Clean previous build
const LIB_DIST_BROWSER = path.join(ROOT, "../lib-dist/browser");

if (fs.existsSync(LIB_DIST_BROWSER)) {
  for (const entry of fs.readdirSync(LIB_DIST_BROWSER)) {
    rmrf(path.join(LIB_DIST_BROWSER, entry));
  }
}

rmrf(path.join(PUBLIC_DIR, "kcab"));

// ---------------------------------------------------------------------------
// Check environment
const NODE_ENV = process.env.NODE_ENV;

// DEV MODE: enable watch & symlink
if (NODE_ENV === "development") {
  VITE_ARGS += " --watch";

  if (process.platform === "win32") {
    process.env.MSYS = "winsymlinks:nativestrict";
  }

  // Create symlink to lib-dist/browser
  const target = path.join(PUBLIC_DIR, "kcab");
  rmrf(target);

  fs.symlinkSync(
    path.join(ROOT, "../lib-dist/browser"),
    target,
    "junction"
  );
}

// ---------------------------------------------------------------------------
// Copy wasm file
const wasmSrc = path.join(
  ROOT,
  "../../../node_modules/@jlongster/sql.js/dist/sql-wasm.wasm"
);
const wasmDest = path.join(PUBLIC_DIR, "sql-wasm.wasm");

fs.copyFileSync(wasmSrc, wasmDest);

// ---------------------------------------------------------------------------
// Run Vite build
run(
  `yarn vite build --config ../vite.config.ts --mode ${NODE_ENV} ${VITE_ARGS}`
);

// ---------------------------------------------------------------------------
// Production: Copy built files
if (NODE_ENV === "production") {
  const destDir = path.join(PUBLIC_DIR, "kcab");
  mkdirp(destDir);

  for (const entry of fs.readdirSync(LIB_DIST_BROWSER)) {
    const src = path.join(LIB_DIST_BROWSER, entry);
    const dest = path.join(destDir, entry);

    const stat = fs.statSync(src);
    if (stat.isDirectory()) {
      // Ensure destination directory exists
      if (!fs.existsSync(dest)) {
        fs.mkdirSync(dest, { recursive: true });
      }

      // Copy each entry in the directory
      const entries = fs.readdirSync(src);
      for (const entry of entries) {
        const srcPath = path.join(src, entry);
        const destPath = path.join(dest, entry);
        copy(srcPath, destPath); // recursive call
      }
    } else {
      // Copy file
      fs.copyFileSync(src, dest);
    }
  }
}
